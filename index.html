<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
    <title>íƒ€ì„ë¼ì¸ ê²Œì‹œë¬¼ ì‘ì„±</title>
    <link rel="stylesheet" href="main.css">

</head>
<body>
<!--ê²Œì‹œê¸€ ìƒì„± ë‹¤ì´ì–¼ë¡œê·¸-->
<div class="container">
    <h3>ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°ğŸ’</h3>
    <span class="closeButton" onclick="closeDialog()">close</span>
    <div class="item">
        <input type="text" placeholder="ì‘ì„±ì ì´ë¦„ ì…ë ¥" id="owner">
        <i class="fas fa-user"></i>
    </div>
    <textarea name="" id="contents" cols="30" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <input type="button" value="ê²Œì‹œ" onclick="getStart()" class="register">
    <span class="bottomContent">Web in Kookmin React Study</span>
</div>

<!--ê²Œì‹œê¸€ ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸-->
<div class="container" id="editDialog">
    <h3>ê²Œì‹œê¸€ ìˆ˜ì •í•˜ê¸°ğŸ’</h3>
    <span class="closeButton" onclick="closeEditDialog()">close</span>
    <div class="item">
        <input type="text" placeholder="ê²Œì‹œê¸€ ë²ˆí˜¸ ì…ë ¥" id="postId">
    </div>
    <textarea name="" id="editContent" cols="30" rows="10" placeholder="ìˆ˜ì • ë‚´ìš© ì…ë ¥"></textarea>
    <input type="button" value="ìˆ˜ì •" onclick="editStart()" class="register">
    <span class="bottomContent">Web in Kookmin React Study</span>
</div>

<div class="first-wrap">
    <div class="gnb">
        <span onclick="showDialog()">Create Content</span>
        <span onclick="showDelete()">Delete Content</span>
        <span onclick="showEdit()">Edit Content</span>
    </div>
<div class="wrap">
    <h1>ìœ™í¬ ë¦¬ì•¡íŠ¸ ìŠ¤í„°ë”” íƒ€ì„ë¼ì¸</h1>

    <div class="timeLine">
<!--        <div class="inner_container">-->
<!--            <h2>ì„ì„±ì›</h2>-->
<!--            <p>ë‚´ìš©ë‚´ìš©</p>-->
<!--        </div>-->
    </div>
</div>
</div>


<script>
    let postInput = document.querySelector('textarea');
    let snsOwner = document.querySelector('#owner');
    let timeLine = document.querySelector('.timeLine');

    window.onload = async () => {
        const postData = await fetch('http://ec2-52-78-131-251.ap-northeast-2.compute.amazonaws.com/feed/', {
            method: 'GET',
        })
        const postResult = await postData.json();
        for (let i = 0; i < postResult.length; i++) {
            post(postResult[i].id,postResult[i].owner, postResult[i].content);
        }
    }

    const showDialog = () => {
        let owner = document.querySelector('#owner');
        let description = document.querySelector('#contents');
        let wrap = document.querySelector('.first-wrap').style.opacity = '0.3';
        owner.value = "";
        description.value = "";

        let diaLog = document.querySelector('.container');
        diaLog.style.display = 'block';
    }
    const closeDialog = () => {
        let wrap = document.querySelector('.first-wrap').style.opacity = '1';
        let diaLog = document.querySelector('.container');
        diaLog.style.display = 'none';
    }
    const showEdit = () => {
        let postID = document.querySelector('#postId');
        let contents = document.querySelector('#editContent');
        let wrap = document.querySelector('.first-wrap').style.opacity = '0.3';
        let editDialog = document.querySelector('#editDialog');
        editDialog.style.display = 'block';
        postID.value = '';
        contents.value = '';
    }
    const closeEditDialog = () => {
        let wrap = document.querySelector('.first-wrap').style.opacity = '1';
        let editDialog = document.querySelector('#editDialog');
        editDialog.style.display = 'none';
    }
    const getStart = () => {
        // let owner = document.querySelector('#owner');
        // let contents = document.querySelector('#contents');

        // post(owner.value, contents.value);
        if(postInput.value === "" || snsOwner.value === "") {
            alert("ë¹ˆì¹¸ ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        else {
            createPost();
        }
    }
    const createPost = async () => {
        await fetch('http://ec2-52-78-131-251.ap-northeast-2.compute.amazonaws.com/feed/', {
            method: 'POST',
            body: JSON.stringify({
                owner: snsOwner.value,
                content: postInput.value,
            }),
            headers: {
                'Content-Type': 'application/json'
            },
        })
        .then(res => res.json())
        .then(res => {
            post(snsOwner.value, postInput.value);
        })
    }

    const post = (id, name, description) => {
        let container = document.createElement('div'); // div íƒœê·¸ ìƒì„±
        let owner = document.createElement('h2'); // ì‘ì„±ì ë“¤ì–´ê°ˆ h1 íƒœê·¸
        let content = document.createElement('p'); // ë‚´ìš© ë“¤ì–´ê°ˆ p íƒœê·¸

        // ê° ê²Œì‹œë¬¼ì— ë§ëŠ” id ê°’ ì„¤ì •
        $(window).ready(function () {
            $(owner).attr('data-content', id);
        });

        owner.appendChild(document.createTextNode(name));
        content.appendChild(document.createTextNode(description));


        container.setAttribute('class', 'inner_container');
        container.appendChild(owner);
        container.appendChild(content);
        timeLine.appendChild(container);

        closeDialog();
    }

    const showDelete = async () => {
        let postId = prompt("ì‚­ì œí•  ê²Œì‹œë¬¼ì˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

        await fetch('http://ec2-52-78-131-251.ap-northeast-2.compute.amazonaws.com/feed/'+postId, {
            method: 'DELETE',
        })
        .then(res => res.json())

    }


    const editStart = () => {
        let postId = document.querySelector('#postId');
        let editContent = document.querySelector('#editContent');

        if(postId.value.length==0 || editContent.value.length==0) {
            alert("ë¹ˆì¹¸ ì—†ì´ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        }
        else {editPost(postId.value.toString(), editContent.value.toString());}
    }
    const editPost = async (id, contents) => {
        await fetch('http://ec2-52-78-131-251.ap-northeast-2.compute.amazonaws.com/feed/'+id+'/',{
            method: 'PATCH',
            body: JSON.stringify({
                content: contents,
            }),
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
                'Accept': 'application/json',
                'Authorization': '',
            },
        })
        .then(res => res.json())
        .then(res => console.log(res))
        .catch(err => {console.log("Error message + "+err)})

        closeEditDialog();
        window.location.reload();
    }

</script>

</body>
</html>
